// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum BrandRole {
  OWNER
  MANAGER
  VIEWER
}

enum CampaignStatus {
  DRAFT
  ACTIVE
  PAUSED
  COMPLETED
}

enum LedgerType {
  MINT
  BURN
}

enum FraudSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum FraudStatus {
  PENDING
  REVIEWED
  RESOLVED
  DISMISSED
}

enum WebhookSource {
  SHOPIFY
  STRIPE
}

model User {
  id            String        @id @default(uuid())
  clerkId       String        @unique
  email         String?       @unique
  phone         String?       @unique
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  isSuspended   Boolean       @default(false)
  isPlatformAdmin Boolean     @default(false)

  brandMemberships BrandMember[]
  redemptions      Redemption[]
  fraudFlags       FraudFlag[]
  rewardLedgers    RewardLedger[]

  @@index([clerkId])
  @@index([email])
  @@index([phone])
}

model Brand {
  id          String        @id @default(uuid())
  name        String
  slug        String        @unique
  description String?
  isActive    Boolean       @default(true)
  isSuspended Boolean       @default(false)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  members     BrandMember[]
  campaigns   Campaign[]
  ledgers     RewardLedger[]
  redemptions Redemption[]
  webhookEvents WebhookEvent[]
  apiKeys     BrandApiKey[]
  webhookSubscriptions WebhookSubscription[]
  integrationEvents IntegrationEvent[]

  // Billing (stub)
  stripeCustomerId String?
  stripeSubscriptionId String?
  billingEmail      String?

  @@index([slug])
  @@index([isActive])
}

model BrandMember {
  id        String    @id @default(uuid())
  userId   String
  brandId  String
  role     BrandRole
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  brand    Brand     @relation(fields: [brandId], references: [id], onDelete: Cascade)

  @@unique([userId, brandId])
  @@index([brandId])
  @@index([userId])
}

model Campaign {
  id          String          @id @default(uuid())
  brandId     String
  name        String
  description String?
  status      CampaignStatus  @default(DRAFT)
  pointsPerDollar Decimal      @default(1.0) // e.g., 1 point per $1 spent
  startDate   DateTime?
  endDate     DateTime?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  brand       Brand           @relation(fields: [brandId], references: [id], onDelete: Cascade)
  redemptions Redemption[]

  @@index([brandId])
  @@index([status])
}

model RewardLedger {
  id          String      @id @default(uuid())
  brandId     String
  userId      String
  type        LedgerType
  amount      Decimal     // Points amount
  reason      String?     // e.g., "checkout.completed", "redemption", "manual_adjustment"
  metadata    Json?       // Additional context
  createdAt   DateTime    @default(now())

  brand       Brand       @relation(fields: [brandId], references: [id], onDelete: Cascade)
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([brandId])
  @@index([userId])
  @@index([type])
  @@index([createdAt])
}

model Redemption {
  id          String      @id @default(uuid())
  brandId     String
  userId      String
  campaignId  String?
  pointsUsed  Decimal
  status      String      @default("pending") // pending, completed, cancelled
  metadata    Json?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  brand       Brand       @relation(fields: [brandId], references: [id], onDelete: Cascade)
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  campaign    Campaign?   @relation(fields: [campaignId], references: [id], onDelete: SetNull)

  @@index([brandId])
  @@index([userId])
  @@index([status])
}

model FraudFlag {
  id          String          @id @default(uuid())
  userId      String
  brandId     String?
  severity    FraudSeverity
  status      FraudStatus     @default(PENDING)
  reason      String
  details     Json?
  reviewedBy  String?         // User ID of reviewer
  reviewedAt  DateTime?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  user        User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([brandId])
  @@index([status])
  @@index([severity])
}

model WebhookEvent {
  id          String          @id @default(uuid())
  brandId     String?
  source      WebhookSource
  eventType   String          // e.g., "checkout.completed"
  rawPayload  Json
  processed   Boolean         @default(false)
  processedAt DateTime?
  error       String?
  createdAt   DateTime        @default(now())

  brand       Brand?          @relation(fields: [brandId], references: [id], onDelete: SetNull)

  @@index([source])
  @@index([eventType])
  @@index([processed])
  @@index([createdAt])
}

model BrandApiKey {
  id         String   @id @default(uuid())
  brand      Brand    @relation(fields: [brandId], references: [id], onDelete: Cascade)
  brandId    String
  name       String
  keyHash    String   @unique
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  lastUsedAt DateTime?

  @@index([brandId])
  @@index([keyHash])
  @@index([isActive])
}

model WebhookSubscription {
  id              String    @id @default(uuid())
  brand           Brand     @relation(fields: [brandId], references: [id], onDelete: Cascade)
  brandId         String
  url             String
  secret          String?
  eventTypes      String[]
  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  lastSuccess     DateTime?
  lastError       DateTime?
  lastErrorMessage String?

  @@index([brandId])
}

model IntegrationEvent {
  id            String    @id @default(uuid())
  brand         Brand     @relation(fields: [brandId], references: [id], onDelete: Cascade)
  brandId       String
  eventName     String
  externalUserId String?
  metadata      Json?
  createdAt     DateTime  @default(now())

  @@index([brandId])
  @@index([eventName])
  @@index([createdAt])
}

